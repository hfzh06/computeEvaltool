#!/bin/bash

################################################
# 1. 当前节点编号（主机=0，从机=1）
################################################
NODE_RANK=1

################################################
# 2. 分布式训练基本参数
################################################
MASTER_ADDR="10.1.18.121"
MASTER_PORT=29566
NNODES=2
GPUS_PER_NODE=8

export NCCL_DEBUG=INFO
export NCCL_SOCKET_IFNAME=bond0
export NCCL_IB_DISABLE=1

################################################
# 3. 输出信息
################################################
echo ""
echo "==============================================================="
echo "         DeepSeek-70B + DeepSpeed 极限性能压力测试"
echo "---------------------------------------------------------------"
echo " NODE_RANK:             ${NODE_RANK}"
echo " MASTER_ADDR:           ${MASTER_ADDR}"
echo " MASTER_PORT:           ${MASTER_PORT}"
echo " NNODES:                ${NNODES}"
echo " GPUS_PER_NODE:         ${GPUS_PER_NODE}"
echo "==============================================================="
echo ""

################################################
# 4. 定义测试组合
################################################
PER_DEVICE_BATCH_LIST=(1 2)
ACCUM_LIST=(1 2 4 8)

cd ~/deepseek

################################################
# 5. 自动测试循环
################################################
for BS in ${PER_DEVICE_BATCH_LIST[@]}; do
  for ACC in ${ACCUM_LIST[@]}; do

    echo ""
    echo "---------------------------------------------------------------"
    echo "  测试: per_device_batch_size = ${BS}, gradient_accum = ${ACC}"
    echo "---------------------------------------------------------------"

    torchrun \
      --nnodes=${NNODES} \
      --node_rank=${NODE_RANK} \
      --nproc-per-node=${GPUS_PER_NODE} \
      --master-addr=${MASTER_ADDR} \
      --master-port=${MASTER_PORT} \
      train_deepseek70b.py \
        --model_path /data/models/deepseek-70b \
        --data_path /data/datasets/open_r1-math-220k \
        --output_dir /data/output/perf_bs${BS}_acc${ACC} \
        --epochs 1 \
        --per_device_batch_size ${BS} \
        --gradient_accumulation_steps ${ACC} \
        --max_length 512 \
        --deepspeed ds_config.json

  done
done

echo ""
echo "==============================================================="
echo "            DeepSeek-70B 极限性能测试完成！"
echo "==============================================================="

